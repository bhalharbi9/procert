<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„Ø£Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ù‚Ø±Ø± Ø§Ù„ØªØ£Ù‡ÙŠÙ„ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

  <style>
    :root{
      --bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;
      --ok:#027a48;--bad:#b42318;--pri:#1d4ed8;
    }
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;margin:20px;background:var(--bg)}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:10px;background:#fff}
    button{cursor:pointer}
    button.primary{background:var(--pri);color:#fff;border-color:var(--pri)}
    button.danger{background:#b42318;color:#fff;border-color:#b42318}
    button.soft{background:#fff;border-color:#ddd}
    .muted{color:var(--muted);font-size:13px}
    .q{padding:12px;border:1px dashed #ddd;border-radius:12px;background:#fafafa;margin:10px 0}
    .q.unanswered{border:2px solid #b42318 !important; background:#fff1f2}
    .q.answered{border:2px solid #86efac !important; background:#f0fdf4}
    .ans{margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .ans.ok{border-color:#86efac;background:#f0fdf4;color:var(--ok)}
    .ans.bad{border-color:#fecaca;background:#fff1f2;color:var(--bad)}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;background:#fff}
    .hidden{display:none}
    .split{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
    .box{flex:1;min-width:260px}
    .kbd{font-family:ui-monospace,Consolas,monospace;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .panel{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
    .panel h4{margin:0 0 8px;font-size:14px}
    .small{font-size:12px;color:#666}
    .warn{color:var(--bad)}
    .okc{color:var(--ok)}
    .progressWrap{width:100%;max-width:520px}
    progress{width:100%;height:14px}

    /* Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
    .mapWrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .mapBtn{
      width:36px;height:34px;border-radius:10px;border:1px solid #ddd;
      background:#fff;cursor:pointer;font-size:12px;
    }
    .mapBtn.unanswered{border-color:#fecaca;background:#fff1f2;color:#b42318}
    .mapBtn.answered{border-color:#86efac;background:#f0fdf4;color:#027a48}
    .mapBtn.active{outline:3px solid rgba(29,78,216,.25);border-color:#1d4ed8}

    /* MATCH: Ø¬Ø¯ÙˆÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ */
    .matchHeader{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .matchCols{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
    .matchCols h4{margin:0 0 8px;font-size:14px}
    .matchRows{margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;overflow:hidden}
    .matchRow{display:grid;grid-template-columns:1fr 190px 1fr;gap:10px;padding:10px;border-top:1px solid #f0f0f0;align-items:center}
    .matchRow:first-child{border-top:none}
    .matchHint{font-size:12px;color:#666;margin-top:6px}
    .badgeOk{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #86efac;background:#f0fdf4;color:#027a48;font-size:12px}
    .badgeBad{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #fecaca;background:#fff1f2;color:#b42318;font-size:12px}
    .tableMini{width:100%;border-collapse:collapse;margin-top:10px}
    .tableMini th,.tableMini td{border:1px solid #eee;padding:8px;font-size:13px}
    .tableMini th{background:#fafafa}

    /* Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ø§Ø¦Ù… (Sticky) */
    .stickyFinish{
      position:fixed;
      left:18px;
      bottom:18px;
      z-index:9999;
      width:min(520px, calc(100vw - 36px));
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      background:#fff;
      border:1px solid #eee;
    }
    .stickyFinish .btn{
      width:100%;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .stickyHint{margin:0 0 10px;font-size:12px;color:#666;line-height:1.5}
    .spacerBottom{height:120px} /* Ø­ØªÙ‰ Ù„Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ø¢Ø®Ø± Ø³Ø¤Ø§Ù„ */

    /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© */
    .test-only.hidden-by-mode{display:none !important;}
  </style>
</head>

<body>

<div class="card">
  <h2 style="margin:0 0 6px">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„Ø£Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ù‚Ø±Ø± Ø§Ù„ØªØ£Ù‡ÙŠÙ„ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h2>
</div>

<div class="card">
  <div class="row">
    <button class="primary" onclick="setMode('review')">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    <button class="primary" onclick="setMode('test')">ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (40 Ø³Ø¤Ø§Ù„)</button>
    <span class="pill">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="modeBadge">Ù…Ø±Ø§Ø¬Ø¹Ø©</b></span>
  </div>
</div>

<!-- Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ø§Ø¦Ù… (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±) -->
<div id="stickyFinish" class="stickyFinish test-only hidden-by-mode hidden">
  <p class="stickyHint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨Ø© ØªÙØ­Ø³Ø¨ (0).</p>
  <button type="button" class="danger btn" onclick="requestFinish('manual')">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
</div>

<!-- Ø§Ø®ØªØ¨Ø§Ø± -->
<div class="card hidden test-only hidden-by-mode" id="testCard">
  <div class="split">
    <div class="box">
      <h3 style="margin:0 0 6px">Ø§Ø®ØªØ¨Ø§Ø± 40 Ø³Ø¤Ø§Ù„ Ù…Ù†ÙˆÙ‘Ø¹Ø©</h3>
      <div class="muted">16 ØµÙˆØ§Ø¨/Ø®Ø·Ø£ â€” 16 Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ â€” 8 ØªÙˆØµÙŠÙ„</div>



      <div class="row" style="margin-top:10px">
        <label class="muted">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚):</label>
        <input id="durationMin" type="number" min="1" value="30" style="width:90px">
        <label class="row" style="gap:6px">
          <input type="checkbox" id="autoRetry">
          <span class="muted">Ø¥Ø¹Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©</span>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="pill">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b id="timeLeft">--:--</b></span>
        <span class="pill">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <b id="tCount">0</b></span>

        <div class="progressWrap">
          <progress id="prog" value="0" max="40"></progress>
          <div class="muted">
            Ø§Ù„ØªÙ‚Ø¯Ù…: <b id="progTxt">0/40</b> â€” <b id="progPct">0%</b>
          </div>
        </div>
      </div>

      <!-- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
      <div class="panel" style="margin-top:10px">
        <h4>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
        <div class="small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù‡ (Ø£Ø®Ø¶Ø±=Ù…Ø¬Ø§Ø¨ØŒ Ø£Ø­Ù…Ø±=ØºÙŠØ± Ù…Ø¬Ø§Ø¨).</div>
        <div id="mapWrap" class="mapWrap"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="primary" onclick="startTest(true)">Ø¨Ø¯Ø¡/Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button class="soft" id="btnResume" onclick="resumeAttempt()" style="display:none">Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
      </div>

      <div class="ans bad hidden" id="unansweredBox"></div>
      <div class="ans ok hidden" id="resumeInfo"></div>

      <div id="testBox"></div>

      <!-- Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø£Ø³ÙÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±) -->
      <div class="panel test-only hidden-by-mode" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div class="small">ÙˆØµÙ„Øª Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†.</div>
          <button type="button" class="danger" style="padding:12px 18px;font-weight:900;font-size:15px;border-radius:14px"
                  onclick="requestFinish('manual')">
            âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©
          </button>
        </div>
      </div>

      <div class="ans ok hidden" id="resultBox"></div>

      <div class="panel hidden" id="detailPanel">
        <h4 style="margin:0 0 8px">ØªÙØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„</h4>
        <div class="muted">Ø¯Ø±Ø¬Ø© ÙƒÙ„ Ø³Ø¤Ø§Ù„ = 1 (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 40) â€” Ø§Ù„Ù†Ø³Ø¨Ø© = 100%</div>
        <div id="detailBox"></div>
      </div>

      <div class="row hidden" id="resultActions" style="margin-top:10px">
        <button class="primary" onclick="restartTest()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØªÙ„ÙØ©</button>
        <input type="hidden" class="soft" onclick="downloadLastResultJSON()">
      </div>

      <div class="spacerBottom"></div>
    </div>

    <div class="box">
      <h3 style="margin:0 0 6px">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
      <div class="muted">ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
      <div class="ans hidden" id="analysisBox"></div>


    </div>
  </div>
</div>

<!-- Ù…Ø±Ø§Ø¬Ø¹Ø© -->
<div class="card" id="reviewCard">
  <div class="row">
    <input id="search" placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„..." style="min-width:260px">
    <select id="type">
      <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
      <option value="tf">ØµÙˆØ§Ø¨/Ø®Ø·Ø£</option>
      <option value="mcq">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</option>
      <option value="match">ØªÙˆØµÙŠÙ„</option>
    </select>

    <select id="showMode">
      <option value="hidden">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø®ÙÙŠØ©</option>
      <option value="oneclick">Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø²Ø±</option>
      <option value="all">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</option>
    </select>

    <button class="primary" onclick="renderReview()">ØªØ·Ø¨ÙŠÙ‚</button>
    <span class="pill">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <b id="count">0</b></span>
  </div>

  <div class="muted" style="margin-top:8px">
    â€¢ ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ØªØ¸Ù‡Ø± <b>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§</b><br>
    â€¢ ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©): (Ø¨) ØªØ¸Ù‡Ø± <b>Ø¹Ù…ÙˆØ¯ÙŠÙ‹Ø§</b>
  </div>

  <div id="reviewBox"></div>
</div>

<script src="questions.js"></script>
<script>
/* ========= LocalStorage Keys ========= */
const LS_LAST = "CERTQUIZ_LAST_RESULT_V2";
const LS_ATTEMPT = "CERTQUIZ_ACTIVE_ATTEMPT_V1";

/* ========= Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ========= */
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pickN(arr,n){ return shuffle(arr).slice(0, Math.min(n, arr.length)); }
function fmt(sec){
  const m=Math.floor(sec/60), s=sec%60;
  return String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
}
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ========= Ø§Ø®ØªÙŠØ§Ø± 40 Ù…Ù†ÙˆÙ‘Ø¹Ø© ========= */
function pickMixed40(bank){
  const tf = pickN(bank.filter(q=>q.type==="tf"), 16);
  const mcq = pickN(bank.filter(q=>q.type==="mcq"), 16);
  const match = pickN(bank.filter(q=>q.type==="match"), 8);

  let picked = [...tf, ...mcq, ...match];
  if(picked.length < 40){
    const remaining = bank.filter(q => !picked.some(p=>p.id===q.id));
    picked = picked.concat(pickN(remaining, 40 - picked.length));
  }
  return shuffle(picked).slice(0,40);
}

/* ========= Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙˆØ¶Ø¹ ========= */
function setMode(mode){
  const isTest = (mode === "test");
  document.getElementById("modeBadge").textContent = isTest ? "Ø§Ø®ØªØ¨Ø§Ø±" : "Ù…Ø±Ø§Ø¬Ø¹Ø©";

  // toggle cards
  document.getElementById("reviewCard").classList.toggle("hidden", isTest);
  document.getElementById("testCard").classList.toggle("hidden", !isTest);

  // toggle test-only blocks (including sticky finish)
  document.querySelectorAll(".test-only").forEach(el=>{
    el.classList.toggle("hidden-by-mode", !isTest);
    // also keep hidden class synced for sticky
    if(el.id === "stickyFinish"){
      el.classList.toggle("hidden", !isTest);
    }
  });

  if(isTest) prepareResumeUI();
}

/* ========= ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ========= */
let testQuestions = [];
let userAnswers = {};
let timerSec = 0;
let timerInt = null;

function startTimer(){
  const mins = Math.max(1, Number(durationMin.value || 30));
  if(!timerSec || timerSec > mins*60) timerSec = mins*60;

  if(timerInt) clearInterval(timerInt);
  timeLeft.textContent = fmt(timerSec);

  timerInt = setInterval(()=>{
    timerSec--;
    timeLeft.textContent = fmt(Math.max(0,timerSec));
    saveAttempt();
    if(timerSec <= 0){
      clearInterval(timerInt);
      requestFinish('timeout');
    }
  }, 1000);
}

/* ===== Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ===== */
function renderMap(){
  const wrap = document.getElementById("mapWrap");
  wrap.innerHTML = "";
  for(let i=0;i<testQuestions.length;i++){
    const b=document.createElement("button");
    b.className="mapBtn unanswered";
    b.textContent = String(i+1);
    b.onclick=()=>goToQ(i);
    b.id="map_"+i;
    wrap.appendChild(b);
  }
  updateMap();
}
function updateMap(activeIdx=null){
  for(let i=0;i<testQuestions.length;i++){
    const q=testQuestions[i];
    const btn=document.getElementById("map_"+i);
    if(!btn) continue;
    const ok=isAnswered(q,i);
    btn.classList.toggle("answered", ok);
    btn.classList.toggle("unanswered", !ok);
    btn.classList.toggle("active", activeIdx===i);
  }
}
function bindActiveOnScroll(){
  const handler = ()=>{
    const tops = testQuestions.map((_,i)=>{
      const el=document.getElementById("tq_"+i);
      if(!el) return {i,top:999999};
      return {i,top:Math.abs(el.getBoundingClientRect().top - 20)};
    });
    tops.sort((a,b)=>a.top-b.top);
    const active = tops[0]?.i ?? null;
    updateMap(active);
  };
  window.removeEventListener("scroll", window.__mapScrollHandler||(()=>{}));
  window.__mapScrollHandler = handler;
  window.addEventListener("scroll", handler, {passive:true});
}

/* ===== Ø±Ø³Ù… Ø³Ø¤Ø§Ù„ ===== */
function renderTestQuestion(q, idx){
  const d=document.createElement("div");
  d.className="q unanswered";
  d.id = "tq_"+idx;

  d.innerHTML=`<b>${idx+1})</b> ${q.q}`;

  const markChanged = ()=>{
    updateQuestionState(idx);
    updateProgress();
    updateMap();
    saveAttempt();
  };

  if(q.type==="tf"){
    ["T","F"].forEach(v=>{
      const l=document.createElement("label");
      l.innerHTML=`<br><input type="radio" name="q${idx}" value="${v}"> ${v==="T"?"ØµÙˆØ§Ø¨":"Ø®Ø·Ø£"}`;
      l.querySelector("input").onchange=e=>{ userAnswers[idx]=e.target.value; markChanged(); };
      d.appendChild(l);
    });
  }

  if(q.type==="mcq"){
    (q.choices||[]).forEach((c,i)=>{
      const l=document.createElement("label");
      l.innerHTML=`<br><input type="radio" name="q${idx}" value="${i}"> ${c}`;
      l.querySelector("input").onchange=e=>{ userAnswers[idx]=Number(e.target.value); markChanged(); };
      d.appendChild(l);
    });
  }

  if(q.type==="match"){
    const map = new Array((q.matchLeft||[]).length).fill(null);

    // Header: (Ø£) Ùˆ(Ø¨) Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ (Ù…Ø±Ø¬Ø¹)
    const header = document.createElement("div");
    header.className = "matchHeader";

    const colA = document.createElement("div");
    colA.className = "matchCols";
    colA.innerHTML = `<h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø£)</h4>` + (q.matchLeft||[])
      .map((x,i)=>`${i+1}) ${escapeHtml(x)}`).join("<br>");

    const colB = document.createElement("div");
    colB.className = "matchCols";
    colB.innerHTML = `<h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨)</h4>` + (q.matchRight||[])
      .map((x,i)=>`${i+1}) ${escapeHtml(x)}`).join("<br>");

    header.appendChild(colA);
    header.appendChild(colB);
    d.appendChild(header);

    const hint = document.createElement("div");
    hint.className = "matchHint";
    hint.textContent = "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨) Ù„ÙƒÙ„ Ø¨Ù†Ø¯ ÙÙŠ (Ø£):";
    d.appendChild(hint);

    // Rows: (Ø£ | Ø§Ø®ØªÙŠØ§Ø± | Ù†Øµ Ù…Ù† Ø¨)
    const rowsBox = document.createElement("div");
    rowsBox.className = "matchRows";

    (q.matchLeft||[]).forEach((lft, j)=>{
      const row = document.createElement("div");
      row.className = "matchRow";

      const aCell = document.createElement("div");
      aCell.innerHTML = `<b>${j+1})</b> ${escapeHtml(lft)}`;

      const sel = document.createElement("select");
      sel.innerHTML =
        `<option value="">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨)</option>` +
        (q.matchRight||[]).map((_,k)=>`<option value="${k}">${k+1}</option>`).join("");

      const bCell = document.createElement("div");
      bCell.className = "muted";
      bCell.textContent = "â€”";

      sel.onchange = ()=>{
        map[j] = (sel.value==="" ? null : Number(sel.value));
        userAnswers[idx] = map;

        if(map[j] === null) bCell.textContent = "â€”";
        else bCell.textContent = `${map[j]+1}) ${(q.matchRight||[])[map[j]] || ""}`;

        markChanged();
      };

      row.appendChild(aCell);
      row.appendChild(sel);
      row.appendChild(bCell);
      rowsBox.appendChild(row);
    });

    d.appendChild(rowsBox);
  }

  return d;
}

/* ===== ØªÙ„ÙˆÙŠÙ† + ØªÙ‚Ø¯Ù… ===== */
function isAnswered(q, idx){
  const a = userAnswers[idx];
  if(q.type==="tf") return a==="T"||a==="F";
  if(q.type==="mcq") return typeof a==="number";
  if(q.type==="match"){
    if(!Array.isArray(a)) return false;
    return Array.isArray(q.answer) && a.length === q.answer.length && a.every(v => typeof v==="number");
  }
  return false;
}
function updateQuestionState(idx){
  const q = testQuestions[idx];
  const el = document.getElementById("tq_"+idx);
  if(!q || !el) return;
  const ok = isAnswered(q, idx);
  el.classList.toggle("unanswered", !ok);
  el.classList.toggle("answered", ok);
}
function updateProgress(){
  const total = testQuestions.length || 40;
  let answered = 0;
  testQuestions.forEach((q,i)=>{ if(isAnswered(q,i)) answered++; });

  prog.max = total;
  prog.value = answered;
  progTxt.textContent = `${answered}/${total}`;
  progPct.textContent = `${Math.round((answered/total)*100)}%`;
}

/* ===== ØºÙŠØ± Ù…Ø¬Ø§Ø¨ ===== */
function getUnanswered(){
  const list=[];
  testQuestions.forEach((q,i)=>{ if(!isAnswered(q,i)) list.push(i); });
  return list;
}
function showUnanswered(list){
  if(!list || list.length === 0){ hideUnanswered(); return; }

  const items = list.map(i=>{
    const n=i+1;
    return `<button class="soft" style="margin:4px;padding:8px" onclick="goToQ(${i})">Ø³Ø¤Ø§Ù„ ${n}</button>`;
  }).join(" ");

  unansweredBox.innerHTML = `
    <b class="warn">ØªÙ†Ø¨ÙŠÙ‡: Ù„Ø¯ÙŠÙƒ Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…Ø¬Ø§Ø¨Ø©.</b><br>
    Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨Ø© (${list.length}):<br>${items}
  `;
  unansweredBox.classList.remove("hidden");
}
function hideUnanswered(){
  unansweredBox.classList.add("hidden");
  unansweredBox.innerHTML = "";
}
function goToQ(i){
  const el=document.getElementById("tq_"+i);
  if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ===== Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ===== */
function saveAttempt(){
  if(!testQuestions.length) return;
  const payload = {
    v:1,
    saved_at: Date.now(),
    durationMin: Number(durationMin.value || 30),
    timerSec,
    qids: testQuestions.map(q=>q.id),
    answers: userAnswers
  };
  localStorage.setItem(LS_ATTEMPT, JSON.stringify(payload));
  prepareResumeUI();
}
function loadAttempt(){
  try{ const raw=localStorage.getItem(LS_ATTEMPT); return raw?JSON.parse(raw):null; }
  catch(e){ return null; }
}
function clearAttempt(){
  localStorage.removeItem(LS_ATTEMPT);
  prepareResumeUI();
}
function prepareResumeUI(){
  const a = loadAttempt();
  btnResume.style.display = a ? "inline-block" : "none";
  if(!a){ resumeInfo.classList.add("hidden"); return; }
  const dt = new Date(a.saved_at).toLocaleString("ar-SA");
  resumeInfo.innerHTML = `ğŸ“Œ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø¨ØªØ§Ø±ÙŠØ®: <b>${dt}</b> â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¦Ù†Ø§ÙÙ‡Ø§.`;
  resumeInfo.classList.remove("hidden");
}
function rehydrateInputsFromAnswers(){
  testQuestions.forEach((q,idx)=>{
    const a = userAnswers[idx];
    if(q.type==="tf"){
      if(a==="T"||a==="F"){
        const radio = document.querySelector(`input[name="q${idx}"][value="${a}"]`);
        if(radio) radio.checked = true;
      }
    }else if(q.type==="mcq"){
      if(typeof a==="number"){
        const radio = document.querySelector(`input[name="q${idx}"][value="${a}"]`);
        if(radio) radio.checked = true;
      }
    }else if(q.type==="match"){
      if(Array.isArray(a)){
        const qEl = document.getElementById("tq_"+idx);
        if(!qEl) return;
        const selects = qEl.querySelectorAll("select");
        let sIndex = 0;
        selects.forEach(sel=>{
          const v = a[sIndex];
          sel.value = (typeof v==="number") ? String(v) : "";
          sIndex++;
        });
      }
    }
  });
}
function resumeAttempt(){
  const a = loadAttempt();
  if(!a){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø­ÙÙˆØ¸Ø©."); return; }

  const bank = Array.isArray(window.QUESTION_BANK) ? window.QUESTION_BANK : [];
  const byId = new Map(bank.map(q=>[q.id,q]));
  const qs = a.qids.map(id=>byId.get(id)).filter(Boolean);

  if(qs.length===0){
    alert("ØªØ¹Ø°Ø± Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ØªØ£ÙƒØ¯ Ù…Ù† questions.js).");
    clearAttempt(); return;
  }

  testQuestions = qs;
  userAnswers = a.answers || {};
  timerSec = Number(a.timerSec || (Number(a.durationMin||30)*60));
  durationMin.value = Number(a.durationMin || 30);

  testBox.innerHTML="";
  tCount.textContent = testQuestions.length;
  testQuestions.forEach((q,i)=> testBox.appendChild(renderTestQuestion(q,i)));

  rehydrateInputsFromAnswers();

  for(let i=0;i<testQuestions.length;i++) updateQuestionState(i);
  updateProgress();
  renderMap();
  bindActiveOnScroll();

  hideUnanswered();
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("detailPanel").classList.add("hidden");
  document.getElementById("resultActions").classList.add("hidden");

  startTimer();
  setMode('test');
  window.scrollTo({top:0, behavior:"smooth"});
}

/* ===== Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ===== */
function startTest(newAttempt=true){
  const bank = Array.isArray(window.QUESTION_BANK) ? window.QUESTION_BANK : [];
  if(bank.length < 40){
    alert("Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ÙƒØ§ÙÙ (ÙŠÙ„Ø²Ù… 40 Ø³Ø¤Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
    return;
  }

  if(newAttempt){
    const a = loadAttempt();
    if(a){
      const ok = confirm("ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŸ");
      if(!ok) return;
      clearAttempt();
    }
  }

  testQuestions = pickMixed40(bank);
  userAnswers = {};
  timerSec = Math.max(1, Number(durationMin.value||30)) * 60;

  hideUnanswered();
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("detailPanel").classList.add("hidden");
  document.getElementById("analysisBox").classList.add("hidden");
  document.getElementById("resultActions").classList.add("hidden");

  testBox.innerHTML="";
  tCount.textContent = testQuestions.length;
  testQuestions.forEach((q,i)=> testBox.appendChild(renderTestQuestion(q,i)));

  for(let i=0;i<testQuestions.length;i++) updateQuestionState(i);
  updateProgress();

  renderMap();
  bindActiveOnScroll();

  saveAttempt();
  startTimer();
  setMode('test');
  window.scrollTo({top:0, behavior:"smooth"});
}

/* ===== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (ÙŠØ³Ù…Ø­ Ø­ØªÙ‰ Ù„Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„) ===== */
function requestFinish(reason){
  const un = getUnanswered();

  let msg = (reason==="timeout")
    ? "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†ØŸ"
    : "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ";

  if(un.length > 0){
    msg += `\n\nØªÙ†Ø¨ÙŠÙ‡: Ù„Ø¯ÙŠÙƒ ${un.length} Ø³Ø¤Ø§Ù„/Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…Ø¬Ø§Ø¨Ø©.\nØ³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨Ù‡Ø§ (0) Ø¯Ø±Ø¬Ø©.`;
    showUnanswered(un);
  } else {
    hideUnanswered();
  }

  if(confirm(msg)){
    finishTest(reason);
  }
}

/* ===== Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© (Ù„Ù„ØªÙ†Ø²ÙŠÙ„ JSON ÙÙ‚Ø·) ===== */
function loadLastResult(){
  try{ const raw=localStorage.getItem(LS_LAST); return raw?JSON.parse(raw):null; }
  catch(e){ return null; }
}
function saveLastResult(obj){
  localStorage.setItem(LS_LAST, JSON.stringify(obj));
}
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function downloadLastResultJSON(){
  const r = loadLastResult();
  if(!r){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ØªÙ†Ø²ÙŠÙ„."); return; }
  const ts = (r.finished_at || Date.now());
  const fn = `quiz_result_${new Date(ts).toISOString().slice(0,19).replaceAll(":","-")}.json`;
  downloadJSON(r, fn);
}

/* ===== Ù†ØªÙŠØ¬Ø© + Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ + ØªØ­Ù„ÙŠÙ„ ===== */
function finishTest(reason){
  try{
    if(timerInt) clearInterval(timerInt);

    const resultBoxEl     = document.getElementById("resultBox");
    const detailPanelEl   = document.getElementById("detailPanel");
    const detailBoxEl     = document.getElementById("detailBox");
    const analysisBoxEl   = document.getElementById("analysisBox");
    const resultActionsEl = document.getElementById("resultActions");

    // ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø³Ø¤Ø§Ù„ (ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨ = 0)
    const details = testQuestions.map((q,i)=>{
      const a = userAnswers[i];
      let ok=false;

      if(q.type==="tf") ok = (a===q.answer);
      else if(q.type==="mcq") ok = (a===q.answer);
      else if(q.type==="match"){
        ok = Array.isArray(a) &&
             Array.isArray(q.answer) &&
             a.length === q.answer.length &&
             a.every((v,j)=>v===q.answer[j]);
      }
      return { n:i+1, type:q.type, ok, score: ok ? 1 : 0 };
    });

    const totalScore = details.reduce((s,x)=>s+x.score,0); // Ù…Ù† 40
    const percent100 = Math.round((totalScore/40)*100);    // Ù…Ù† 100
    const unCount = getUnanswered().length;

    // Ø­ÙØ¸ Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© (Ù„Ù„Ù€ JSON)
    const payload = {
      v: 1,
      finished_at: Date.now(),
      reason: reason,
      total_questions: 40,
      score_40: totalScore,
      percent_100: percent100,
      unanswered: unCount,
      breakdown: {
        tf: details.filter(d=>d.type==="tf").reduce((s,x)=>s+x.score,0),
        mcq: details.filter(d=>d.type==="mcq").reduce((s,x)=>s+x.score,0),
        match: details.filter(d=>d.type==="match").reduce((s,x)=>s+x.score,0),
      },
      details: details
    };
    saveLastResult(payload);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    resultBoxEl.innerHTML =
      `âœ… <b>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</b><br>
       Ø§Ù„Ø¯Ø±Ø¬Ø©: <b>${totalScore} / 40</b><br>
       Ø§Ù„Ù†Ø³Ø¨Ø©: <b>${percent100}%</b><br>
       ØºÙŠØ± Ù…Ø¬Ø§Ø¨: <b>${unCount}</b> Ø³Ø¤Ø§Ù„`;
    resultBoxEl.classList.remove("hidden");

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const tbl = `
      <table class="tableMini">
        <thead>
          <tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>
        </thead>
        <tbody>
          ${details.map(x=>`
            <tr>
              <td>${x.n}</td>
              <td>${String(x.type).toUpperCase()}</td>
              <td>${x.ok ? '<span class="badgeOk">ØµØ­ÙŠØ­</span>' : '<span class="badgeBad">Ø®Ø·Ø£</span>'}</td>
              <td><b>${x.score}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    detailBoxEl.innerHTML = tbl;
    detailPanelEl.classList.remove("hidden");

    // ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const tfT = details.filter(d=>d.type==="tf");
    const mcT = details.filter(d=>d.type==="mcq");
    const mtT = details.filter(d=>d.type==="match");
    const sum = arr => arr.reduce((s,x)=>s+x.score,0);
    const pct = (s,t)=> t? Math.round((s/t)*100) : 0;

    const tfS = sum(tfT), mcS=sum(mcT), mS=sum(mtT);
    analysisBoxEl.innerHTML =
      `ğŸ“Š <b>ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</b><br><br>
       ØµÙˆØ§Ø¨/Ø®Ø·Ø£: <b>${tfS}/${tfT.length}</b> â€” <b>${pct(tfS, tfT.length)}%</b><br>
       Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯: <b>${mcS}/${mcT.length}</b> â€” <b>${pct(mcS, mcT.length)}%</b><br>
       ØªÙˆØµÙŠÙ„: <b>${mS}/${mtT.length}</b> â€” <b>${pct(mS, mtT.length)}%</b>`;
    analysisBoxEl.classList.remove("hidden");

    // Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    resultActionsEl.classList.remove("hidden");

    // Ø¥Ù†Ù‡Ø§Ø¡/Ù…Ø³Ø­ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø­ÙÙˆØ¸Ø©
    if(typeof clearAttempt === "function") clearAttempt();

    // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ù†ØªÙŠØ¬Ø©
    resultBoxEl.scrollIntoView({behavior:"smooth", block:"start"});

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    if(autoRetry.checked) setTimeout(()=>restartTest(), 1200);

  }catch(err){
    console.error(err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ finishTest. Ø§ÙØªØ­ Console (F12) ÙˆØ´ÙˆÙ Ø§Ù„Ø®Ø·Ø£.");
  }
}

function restartTest(){ startTest(true); }

/* ========= ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ========= */
function answerText(q){
  if(q.type==="tf") return q.answer==="T"?"ØµÙˆØ§Ø¨ âœ…":"Ø®Ø·Ø£ âŒ";
  if(q.type==="mcq"){
    const idx=q.answer;
    const choice=q.choices?.[idx] ?? "(ØºÙŠØ± Ù…ØªÙˆÙØ±)";
    return `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: (${idx+1}) ${choice}`;
  }
  if(q.type==="match"){
    const lines=(q.matchLeft||[]).map((l,i)=>{
      const rIdx=q.answer[i];
      const rTxt=q.matchRight?.[rIdx] ?? "(ØºÙŠØ± Ù…ØªÙˆÙØ±)";
      return `${i+1}) ${l} â†’ ${rIdx+1}) ${rTxt}`;
    });
    return "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:\n"+lines.join("\n");
  }
  return "";
}

function renderReview(){
  const s=(search.value||"").toLowerCase().trim();
  const t=type.value;
  const mode=showMode.value;

  const bank=Array.isArray(window.QUESTION_BANK)?window.QUESTION_BANK:[];
  const filtered=bank.filter(q=>{
    const okType=(t==="all")?true:q.type===t;
    const okSearch=!s?true:(q.q||"").toLowerCase().includes(s);
    return okType && okSearch;
  });

  count.textContent=filtered.length;
  reviewBox.innerHTML="";

  if(filtered.length===0){
    reviewBox.innerHTML=`<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;
    return;
  }

  filtered.forEach(q=>{
    const card=document.createElement("div");
    card.className="q";
    card.innerHTML=`<b>#${q.id}</b> <span class="pill">${q.type}</span><div style="margin-top:6px">${q.q}</div>`;

    if(q.type==="mcq" && Array.isArray(q.choices)){
      const l=document.createElement("div");
      l.className="panel";
      l.style.marginTop="10px";
      l.innerHTML = `<b>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</b><br>` + q.choices.map((c,i)=>`${i+1}) ${escapeHtml(c)}`).join("<br>");
      card.appendChild(l);
    }

    if(q.type==="match"){
      const wrap=document.createElement("div");
      wrap.className="grid2";
      wrap.style.marginTop="10px";

      const left=document.createElement("div");
      left.className="panel";
      left.innerHTML = `<h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø£)</h4>` + (q.matchLeft||[]).map((x,i)=>`${i+1}) ${escapeHtml(x)}`).join("<br>");

      // âœ… (Ø¨) Ø¹Ù…ÙˆØ¯ÙŠ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
      const right=document.createElement("div");
      right.className="panel";
      right.innerHTML = `<h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨)</h4>` + (q.matchRight||[]).map((x,i)=>`${i+1}) ${escapeHtml(x)}`).join("<br>");

      wrap.appendChild(left);
      wrap.appendChild(right);
      card.appendChild(wrap);
    }

    const ans=document.createElement("pre");
    ans.className="ans ok";
    ans.style.whiteSpace="pre-wrap";
    ans.textContent=answerText(q);

    if(mode==="all"){
      card.appendChild(ans);
    }else if(mode==="oneclick"){
      const btn=document.createElement("button");
      btn.className="soft";
      btn.textContent="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
      btn.onclick=()=>{
        if(ans.parentNode){ ans.remove(); btn.textContent="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"; }
        else{ card.appendChild(ans); btn.textContent="Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"; }
      };
      card.appendChild(document.createElement("div")).appendChild(btn);
    }else{
      const hint=document.createElement("div");
      hint.className="muted";
      hint.style.marginTop="8px";
      hint.textContent="(Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø®ÙÙŠØ©)";
      card.appendChild(hint);
    }

    reviewBox.appendChild(card);
  });
}

/* ========= ØªØ´ØºÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ =========
   - Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
   - Ø§Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© + ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
*/
(function init(){
  // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù…Ø±Ø§Ø¬Ø¹Ø© + Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„
  showMode.value = "all";
  type.value = "all";
  setMode("review");
  renderReview();
  prepareResumeUI(); // Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ø§Ø³ØªØ¦Ù†Ø§Ù Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
})();
</script>

</body>
</html>
